<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Low-Level Functions · StarFormationHistories.jl</title><meta name="title" content="Low-Level Functions · StarFormationHistories.jl"/><meta property="og:title" content="Low-Level Functions · StarFormationHistories.jl"/><meta property="twitter:title" content="Low-Level Functions · StarFormationHistories.jl"/><meta name="description" content="Documentation for StarFormationHistories.jl."/><meta property="og:description" content="Documentation for StarFormationHistories.jl."/><meta property="twitter:description" content="Documentation for StarFormationHistories.jl."/><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../search_index.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../../">StarFormationHistories.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../">Overview</a></li><li><span class="tocitem">Deriving Star Formation Histories from Hess Diagrams</span><ul><li><a class="tocitem" href="../fitting_intro/">Background and Template Construction</a></li><li><a class="tocitem" href="../unconstrained/">High-Level Methods for Unconstrained Fitting</a></li><li><input class="collapse-toggle" id="menuitem-2-3" type="checkbox"/><label class="tocitem" for="menuitem-2-3"><span class="docs-label">Constrained Metallicity Evolution</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../hierarchical/overview/">Overview</a></li><li><input class="collapse-toggle" id="menuitem-2-3-2" type="checkbox"/><label class="tocitem" for="menuitem-2-3-2"><span class="docs-label">AMRs</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../hierarchical/linear_amr/">Linear Age-Metallicity Relation</a></li><li><a class="tocitem" href="../hierarchical/log_amr/">Logarithmic Age-Metallicity Relation</a></li><li><a class="tocitem" href="../hierarchical/fixed_amr/">Fixed Age-Metallicity Relations</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-2-3-3" type="checkbox"/><label class="tocitem" for="menuitem-2-3-3"><span class="docs-label">MZRs</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../hierarchical/MZR/MZR/">Mass-Metallicity Relations (MZRs)</a></li></ul></li><li><a class="tocitem" href="../hierarchical/dispersion_models/">Metallicity Dispersion Models</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-2-4" type="checkbox" checked/><label class="tocitem" for="menuitem-2-4"><span class="docs-label">Internals</span><i class="docs-chevron"></i></label><ul class="collapsed"><li class="is-active"><a class="tocitem" href>Low-Level Functions</a></li><li><a class="tocitem" href="../kernels/">Kernels</a></li></ul></li></ul></li><li><a class="tocitem" href="../../examples/">Examples</a></li><li><a class="tocitem" href="../../simulate/">Simulating Color-Magnitude Diagrams</a></li><li><a class="tocitem" href="../../binaries/">Binary Systems</a></li><li><a class="tocitem" href="../../helpers/">Helper Functions</a></li><li><a class="tocitem" href="../../doc_index/">Index</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Deriving Star Formation Histories from Hess Diagrams</a></li><li><a class="is-disabled">Internals</a></li><li class="is-active"><a href>Low-Level Functions</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Low-Level Functions</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/cgarling/StarFormationHistories.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/cgarling/StarFormationHistories.jl/blob/main/docs/src/fitting/internals.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Low-Level-Functions"><a class="docs-heading-anchor" href="#Low-Level-Functions">Low-Level Functions</a><a id="Low-Level-Functions-1"></a><a class="docs-heading-anchor-permalink" href="#Low-Level-Functions" title="Permalink"></a></h1><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="StarFormationHistories.composite!" href="#StarFormationHistories.composite!"><code>StarFormationHistories.composite!</code></a> — <span class="docstring-category">Function</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs"> composite!(composite::AbstractMatrix{&lt;:Number},
            coeffs::AbstractVector{&lt;:Number},
            models::AbstractVector{T}) where T &lt;: AbstractMatrix{&lt;:Number}</code></pre><p>Updates the <code>composite</code> matrix in place with the linear combination of <code>sum( coeffs .* models )</code>; this is equation 1 in Dolphin 2002, <span>$m_i = \sum_j \, r_j \, c_{i,j}$</span>.</p><p><strong>Examples</strong></p><pre><code class="language-julia hljs">julia&gt; C = zeros(5,5);
julia&gt; models = [rand(size(C)...) for i in 1:5];
julia&gt; coeffs = rand(length(models));
julia&gt; composite!(C, coeffs, models);
julia&gt; C ≈ sum( coeffs .* models)
true</code></pre></div><a class="docs-sourcelink" target="_blank" href="https://github.com/cgarling/StarFormationHistories.jl/blob/901f1c0f1a50ab9b90658688127cd8c6ecefd2e6/src/fitting/fitting_base.jl#L3-L19">source</a></section><section><div><pre><code class="language-julia hljs">composite!(composite::AbstractVector{&lt;:Number},
           coeffs::AbstractVector{&lt;:Number},
           models::AbstractMatrix{&lt;:Number})</code></pre><p>Updates the <code>composite</code> vector with the matrix-vector product of <code>models * coeffs</code>. This is equation 1 in Dolphin 2002, <span>$m_i = \sum_j \, r_j \, c_{i,j}$</span>.</p><p><strong>Examples</strong></p><pre><code class="language-julia hljs">julia&gt; hist_size = (5,10);
julia&gt; models = reduce(hcat,rand(prod(hist_size)) for i in 1:20);
julia&gt; coeffs = rand(length(axes(models,2)));
julia&gt; C = zeros(length(axes(models,1)));
julia&gt; composite!(C, coeffs, models);
julia&gt; C ≈ models * coeffs
true</code></pre><p><strong>Notes</strong></p><p>While the other call signature for this function more closely mirrors the natural data structure for Hess diagrams (2D matrices for <code>composite</code> and each entry in <code>models</code>), this method operates on the same data but flattened. Thus <code>composite</code> becomes a vector rather than a matrix and <code>models</code> becomes a single matrix rather than a vector of matrices. The method <a href="../fitting_intro/#StarFormationHistories.stack_models"><code>StarFormationHistories.stack_models</code></a> is provided to stack the <code>models</code> into this format. This data layout enables us to use the highly optimized <code>LinearAlgebra.mul!</code> function to perform the matrix-vector product which typically achieves &gt;30% speedup relative to the more <em>natural</em> formulation. Additionally, as <code>mul!</code> will typically call to a BLAS matrix-vector product function like <code>gemv!</code> for our use-case, we can switch out Julia&#39;s default OpenBLAS at runtime for other BLAS libraries with Julia bindings like MKL and Apple Accelerate, enabling even greater performance improvements.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/cgarling/StarFormationHistories.jl/blob/901f1c0f1a50ab9b90658688127cd8c6ecefd2e6/src/fitting/fitting_base.jl#L34-L55">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="StarFormationHistories.loglikelihood" href="#StarFormationHistories.loglikelihood"><code>StarFormationHistories.loglikelihood</code></a> — <span class="docstring-category">Function</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">loglikelihood(composite::AbstractArray{&lt;:Number}, data::AbstractArray{&lt;:Number})</code></pre><p>Returns the logarithm of the Poisson likelihood ratio given by equation 10 in Dolphin 2002,</p><p class="math-container">\[\text{ln} \, \mathscr{L} = \sum_i -m_i + n_i \times \left( 1 - \text{ln} \, \left( \frac{n_i}{m_i} \right) \right)\]</p><p>with <code>composite</code> being the complex Hess model diagram <span>$m_i$</span> (see <a href="#StarFormationHistories.composite!"><code>StarFormationHistories.composite!</code></a>) and <code>data</code> being the observed Hess diagram <span>$n_i$</span>.</p><p><strong>Performance Notes</strong></p><ul><li>~18.57 μs for <code>composite=Matrix{Float64}(undef,99,99)</code> and <code>data=similar(composite)</code>.</li><li>~20 μs for <code>composite=Matrix{Float64}(undef,99,99)</code> and <code>data=Matrix{Int64}(undef,99,99)</code>.</li><li>~9.3 μs for <code>composite=Matrix{Float32}(undef,99,99)</code> and <code>data=similar(composite)</code>.</li><li>~9.6 μs for <code>composite=Matrix{Float32}(undef,99,99)</code> and <code>data=Matrix{Int64}(undef,99,99)</code>.</li></ul></div><a class="docs-sourcelink" target="_blank" href="https://github.com/cgarling/StarFormationHistories.jl/blob/901f1c0f1a50ab9b90658688127cd8c6ecefd2e6/src/fitting/fitting_base.jl#L67-L83">source</a></section><section><div><pre><code class="language-julia hljs">loglikelihood(coeffs::AbstractVector{&lt;:Number},
              models::AbstractVector{T},
              data::AbstractMatrix{&lt;:Number}) where T &lt;: AbstractMatrix{&lt;:Number}
loglikelihood(coeffs::AbstractVector{&lt;:Number},
              models::AbstractMatrix{&lt;:Number},
              data::AbstractVector{&lt;:Number})</code></pre><p>Returns the logarithm of the Poisson likelihood ratio, but constructs the complex Hess diagram model as <code>sum(coeffs .* models)</code> rather than taking <code>composite</code> directly as an argument. Second call signature supports the flattened formats for <code>models</code> and <code>data</code>. See the notes for the flattened call signature of <a href="#StarFormationHistories.composite!"><code>StarFormationHistories.composite!</code></a> for more details.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/cgarling/StarFormationHistories.jl/blob/901f1c0f1a50ab9b90658688127cd8c6ecefd2e6/src/fitting/fitting_base.jl#L99-L108">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="StarFormationHistories.∇loglikelihood" href="#StarFormationHistories.∇loglikelihood"><code>StarFormationHistories.∇loglikelihood</code></a> — <span class="docstring-category">Function</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">∇loglikelihood(model::AbstractArray{&lt;:Number},
               composite::AbstractArray{&lt;:Number},
               data::AbstractArray{&lt;:Number})</code></pre><p>Returns the partial derivative of the logarithm of the Poisson likelihood ratio (<a href="#StarFormationHistories.loglikelihood"><code>StarFormationHistories.loglikelihood</code></a>) with respect to the coefficient <span>$r_j$</span> on the provided <code>model</code>. If the complex Hess diagram model is <span>$m_i = \sum_j \, r_j \, c_{i,j}$</span>, then <code>model</code> is <span>$c_{i,j}$</span>, and this function computes the partial derivative of <span>$\text{log} \, \mathscr{L}$</span> with respect to the coefficient <span>$r_j$</span>. This is given by equation 21 in Dolphin 2002,</p><p class="math-container">\[\frac{\partial \, \text{log} \, \mathscr{L}}{\partial \, r_j} = \sum_i c_{i,j} \left( \frac{n_i}{m_i} - 1 \right)\]</p><p>where <span>$n_i$</span> is bin <span>$i$</span> of the observed Hess diagram <code>data</code>. </p><p><strong>Performance Notes</strong></p><ul><li>~4.1 μs for model, composite, data all being <code>Matrix{Float64}(undef,99,99)</code>.</li><li>~1.3 μs for model, composite, data all being <code>Matrix{Float32}(undef,99,99)</code>. </li></ul></div><a class="docs-sourcelink" target="_blank" href="https://github.com/cgarling/StarFormationHistories.jl/blob/901f1c0f1a50ab9b90658688127cd8c6ecefd2e6/src/fitting/fitting_base.jl#L129-L145">source</a></section><section><div><pre><code class="language-julia hljs">∇loglikelihood(models::AbstractVector{T},
               composite::AbstractMatrix{&lt;:Number},
               data::AbstractMatrix{&lt;:Number}) where T &lt;: AbstractMatrix{&lt;:Number}
∇loglikelihood(models::AbstractMatrix{&lt;:Number},
               composite::AbstractVector{&lt;:Number},
               data::AbstractVector{&lt;:Number})</code></pre><p>Computes the gradient of the logarithm of the Poisson likelihood ratio with respect to the coefficients by calling the single-model <code>∇loglikelihood</code> for every model in <code>models</code>. Second call signature supports the flattened formats for <code>models</code> and <code>data</code>. See the notes for the flattened call signature of <a href="#StarFormationHistories.composite!"><code>StarFormationHistories.composite!</code></a> for more details.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/cgarling/StarFormationHistories.jl/blob/901f1c0f1a50ab9b90658688127cd8c6ecefd2e6/src/fitting/fitting_base.jl#L163-L172">source</a></section><section><div><pre><code class="language-julia hljs">∇loglikelihood(coeffs::AbstractVector{&lt;:Number},
               models::AbstractVector{T},
               data::AbstractMatrix{&lt;:Number}) where T &lt;: AbstractMatrix{&lt;:Number}
∇loglikelihood(coeffs::AbstractVector{&lt;:Number},
               models::AbstractMatrix{&lt;:Number},
               data::AbstractVector{&lt;:Number})</code></pre><p>Forms the composite matrix from coefficients <code>coeffs</code> and model templates <code>models</code> and returns the gradient of the loglikelihood with respect to the coefficients. Second call signature supports the flattened formats for <code>models</code> and <code>data</code>. See the notes for the flattened call signature of <a href="#StarFormationHistories.composite!"><code>StarFormationHistories.composite!</code></a> for more details.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/cgarling/StarFormationHistories.jl/blob/901f1c0f1a50ab9b90658688127cd8c6ecefd2e6/src/fitting/fitting_base.jl#L185-L194">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="StarFormationHistories.∇loglikelihood!" href="#StarFormationHistories.∇loglikelihood!"><code>StarFormationHistories.∇loglikelihood!</code></a> — <span class="docstring-category">Function</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs"> ∇loglikelihood!(G::AbstractVector,
                 composite::AbstractMatrix{&lt;:Number},
                 models::AbstractVector{S},
                 data::AbstractMatrix{&lt;:Number}) where S &lt;: AbstractMatrix{&lt;:Number}</code></pre><p>Efficiently computes the gradient of <a href="#StarFormationHistories.loglikelihood"><code>StarFormationHistories.loglikelihood</code></a> with respect to all coefficients by updating <code>G</code> with the gradient. This will overwrite <code>composite</code> with the result of <code>1 .- (data ./ composite)</code> so it shouldn&#39;t be reused after being passed to this function. </p><p><strong>Arguments</strong></p><ul><li><code>G::AbstractVector</code> is the vector that  will be mutated in-place with the computed gradient values.</li><li><code>models::AbstractVector{&lt;:AbstractMatrix{&lt;:Number}}</code> is the vector of matrices giving the model Hess diagrams.</li><li><code>composite::AbstractMatrix{&lt;:Number}</code> is a matrix that contains the composite model <code>sum(coeffs .* models)</code>.</li><li><code>data::AbstractMatrix{&lt;:Number}</code> contains the observed Hess diagram that is being fit.</li></ul></div><a class="docs-sourcelink" target="_blank" href="https://github.com/cgarling/StarFormationHistories.jl/blob/901f1c0f1a50ab9b90658688127cd8c6ecefd2e6/src/fitting/fitting_base.jl#L215-L228">source</a></section><section><div><pre><code class="language-julia hljs">G = ∇loglikelihood!(G::AbstractVector,
                    composite::AbstractVector{&lt;:Number},
                    models::AbstractMatrix{&lt;:Number},
                    data::AbstractVector{&lt;:Number})</code></pre><p>Updates and returns <code>G</code> with the gradient of the loglikelihood with respect to all coefficients. This call signature supports the flattened formats for <code>models</code> and <code>data</code>. See the notes for the flattened call signature of <a href="#StarFormationHistories.composite!"><code>StarFormationHistories.composite!</code></a> for more details.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/cgarling/StarFormationHistories.jl/blob/901f1c0f1a50ab9b90658688127cd8c6ecefd2e6/src/fitting/fitting_base.jl#L260-L267">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="StarFormationHistories.fg!" href="#StarFormationHistories.fg!"><code>StarFormationHistories.fg!</code></a> — <span class="docstring-category">Function</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">fg!(F, G, MH_model0::AbstractMetallicityModel,
    disp_model0::AbstractDispersionModel,
    variables::AbstractVector{&lt;:Number},
    models::Union{AbstractMatrix{&lt;:Number},
                  AbstractVector{&lt;:AbstractMatrix{&lt;:Number}}},
    data::Union{AbstractVector{&lt;:Number}, AbstractMatrix{&lt;:Number}},
    composite::Union{AbstractVector{&lt;:Number}, AbstractMatrix{&lt;:Number}},
    logAge::AbstractVector{&lt;:Number},
    metallicities::AbstractVector{&lt;:Number})</code></pre><p>Main function that differs between AMR and MZR models that accounts for the difference in the gradient formulations between models. <code>F</code> and <code>G</code> mirror the <a href="https://julianlsolvers.github.io/Optim.jl/stable/user/tipsandtricks/#Avoid-repeating-computations">Optim.jl</a> interface for computing the objective and gradient in a single function to make use of common intermediate computations.</p><p><strong>Arguments</strong></p><ul><li><code>F</code> controls whether the objective is being requested. If <code>!isnothing(F)</code>, the negative log likelihood will be returned from <code>fg!</code>.</li><li><code>G</code> controls whether the gradient of the objective with respect to the <code>variables</code> is being requested. If <code>!isnothing(G)</code>, <code>G</code> will be updated in-place with the gradient of the negative log likelihood with respect to the fitting parameters <code>variables</code>.</li><li><code>MH_model0</code> is an instance of a concrete subtype of <code>AbstractMetallicityModel</code> (e.g., <a href="../hierarchical/MZR/MZR/#StarFormationHistories.PowerLawMZR"><code>PowerLawMZR</code></a>) that specifies the metallicity evolution model to use. The parameters contained in <code>MH_model0</code> are used as initial parameters to begin the optimization in <a href="../hierarchical/overview/#StarFormationHistories.fit_sfh"><code>fit_sfh</code></a>, but are not used internally in <code>fg!</code> – new instances are constructed from <code>variables</code> instead.</li><li><code>disp_model0</code> is an instance of a concrete subtype of <code>AbstractDispersionModel</code> (e.g., <a href="../hierarchical/dispersion_models/#StarFormationHistories.GaussianDispersion"><code>GaussianDispersion</code></a>) that specifies the PDF of the metallicities of stars forming at fixed time. The parameters contained in <code>disp_model0</code> are used as initial parameters to begin the optimization in <a href="../hierarchical/overview/#StarFormationHistories.fit_sfh"><code>fit_sfh</code></a>, but are not used internally in <code>fg!</code> – new instances are constructed from <code>variables</code> instead.</li><li><code>variables</code> are the fitting parameters, including <em>free and fixed</em> parameters. This vector is split into stellar mass coefficients <code>R_j</code>, metallicity model parameters, and dispersion model parameters, and so must contain all relevant fittable parameters, even those that are to be fixed during the solve.</li><li><code>models</code> are the template Hess diagrams for the SSPs that compose the observed Hess diagram.</li><li><code>data</code> is the Hess diagram for the observed data.</li><li><code>composite</code> is the pre-allocated array in which to store the complex Hess diagram model. Must have same shape as <code>data</code>.</li><li><code>logAge::AbstractVector{&lt;:Number}</code> is the vector containing the effective ages of the stellar populations used to create the templates in <code>models</code>, in units of <code>log10(age [yr])</code>. For example, if a population has an age of 1 Myr, its entry in <code>logAge</code> should be <code>log10(10^6) = 6.0</code>.</li><li><code>metallicities::AbstractVector{&lt;:Number}</code> is the vector containing the effective metallicities of the stellar populations used to create the templates in <code>models</code>. These should be logarithmic abundances like [M/H] or [Fe/H]. There are some notes on the <a href="https://en.wikipedia.org/wiki/Metallicity">Wikipedia</a> that might be useful.</li></ul><p><strong>Returns</strong></p><ul><li>Negative log likelihood if <code>!isnothing(F)</code>.</li></ul></div><a class="docs-sourcelink" target="_blank" href="https://github.com/cgarling/StarFormationHistories.jl/blob/901f1c0f1a50ab9b90658688127cd8c6ecefd2e6/src/fitting/hierarchical/generic_fitting.jl#L60-L87">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="StarFormationHistories.truncate_relweights" href="#StarFormationHistories.truncate_relweights"><code>StarFormationHistories.truncate_relweights</code></a> — <span class="docstring-category">Function</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">keep_idx::Vector{Int} =
    truncate_relweights(relweightsmin::Number,
                        relweights::AbstractVector{&lt;:Number},
                        logAge::AbstractVector{&lt;:Number})</code></pre><p>Method to truncate an isochrone grid with log10(age [yr]) values <code>logAge</code> and relative weights <code>relweights</code> derived from a hierarchical metallicity evolution model to only include template models with <code>relweights</code> greater than <code>relweightsmin</code> times the maximum relative weight for each unique entry in <code>logAge</code>. The input vectors are the same as those for <a href="../hierarchical/fixed_amr/#StarFormationHistories.fixed_amr"><code>StarFormationHistories.fixed_amr</code></a>, which includes more information. Returns a vector of the indices into <code>relweights</code> and <code>logAge</code> of the template models whose relative weights are significant given the provided <code>relweightsmin</code>.</p><p><strong>Examples</strong></p><p>When using a fixed input age-metallicity relation as enabled by, for example, <a href="../hierarchical/fixed_amr/#StarFormationHistories.fixed_amr"><code>StarFormationHistories.fixed_amr</code></a>, only the star formation rate (or total stellar mass) coefficients need to be fit, as the metallicity distribution is no longer a free parameter in the model. As such, the relative weights of each model with identical <code>logAge</code> but different <code>metallicities</code> only need to be computed once at the start of the optimization. As the metallicity distribution is not a free parameter, it is also possible to truncate the list of models to only those that contribute significantly to the final composite model to improve runtime performance. That is what this method does.</p><p>A simple isochrone grid will be two-dimensional, encompassing age and metallicity. Consider a subset of the model grid with the same age such that <code>unique(logAge) = [10.0]</code> but a series of different metallicities, <code>metallicities = -2.5:0.25:0</code>. If we model the metallicity distribution function for this age as having a mean [M/H] of -2.0 and a Gaussian spread of 0.2 dex, then the relative weights of these models can be approximated as </p><pre><code class="language-julia hljs">import Distributions: Normal, pdf
metallicities = -2.5:0.25:0
relweights = pdf.(Normal(-2.0, 0.2), metallicities)
relweights ./= sum(relweights) # Normalize the relative weights to unity sum</code></pre><pre><code class="nohighlight hljs">11-element Vector{Float64}:
 0.021919934465195145
 0.2284109622221623
 0.4988954088848224
 0.2284109622221623
 0.021919934465195145
 0.0004409368867815243
 1.8592101580561089e-6
 1.6432188478108614e-9
 3.0442281937632026e-13
 1.1821534989089337e-17
 9.622444440364979e-23</code></pre><p>Several of these models with very low relative weights are unlikely to contribute significantly to the final composite model. We can select out only the significant ones with, say, relative weights greater than 10% of the maximum as <code>StarFormationHistories.truncate_relweights(0.1, relweights, fill(10.0,length(metallicities)))</code> which will return indices into <code>relweights</code> whose values are greater than <code>0.1 * maximum(relweights) = 0.04988954088848224</code>,</p><pre><code class="nohighlight hljs">3-element Vector{Int64}:
 2
 3
 4</code></pre><p>which correspond to <code>relweights[2,3,4] = [ 0.2284109622221623, 0.4988954088848224, 0.2284109622221623 ]</code>. If we use only these 3 templates in the fit, instead of the original 11, we will achieve a speedup of almost 4x with a minor loss in precision which, in most cases, will be less than the numerical uncertainties on the individual star formation rate parameters. However, as fits of these sort are naturally quite fast, we recommend use of this type of truncation only in applications where many fits are required (e.g., Monte Carlo experiments). For most applications, this level of optimization is not necessary.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/cgarling/StarFormationHistories.jl/blob/901f1c0f1a50ab9b90658688127cd8c6ecefd2e6/src/fitting/hierarchical/fixed_amr.jl#L174-L219">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="StarFormationHistories.calculate_edges" href="#StarFormationHistories.calculate_edges"><code>StarFormationHistories.calculate_edges</code></a> — <span class="docstring-category">Function</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">calculate_edges(edges, xlim, ylim, nbins, xwidth, ywidth)</code></pre><p>Function to calculate the bin edges for 2D histograms. Returns <code>(xbins, ybins)</code> with both entries being ranges.</p><p><strong>Keyword Arguments</strong></p><ul><li><code>edges</code> is a tuple of ranges defining the left-side edges of the bins along the x-axis (edges[1]) and the y-axis (edges[2]). Example: <code>(-1.0:0.1:1.5, 22:0.1:27.2)</code>. If <code>edges</code> is provided, it will simply be returned.</li><li><code>xlim</code> is a length-2 indexable object (e.g., a Vector{Float64} or NTuple{2,Float64)) giving the lower and upper bounds on the x-axis corresponding to the provided <code>colors</code> array. Example: <code>[-1.0, 1.5]</code>. This is only used if <code>edges==nothing</code>.</li><li><code>ylim</code> is like <code>xlim</code> but  for the y-axis corresponding to the provided <code>mags</code> array. Example <code>[25, 20]</code>. This is only used if <code>edges==nothing</code>.</li><li><code>nbins::NTuple{2,&lt;:Integer}</code> is a 2-tuple of integers providing the number of bins to use along the x- and y-axes. This is only used if <code>edges==nothing</code>.</li><li><code>xwidth</code> is the bin width along the x-axis for the <code>colors</code> array. This is only used if <code>edges==nothing</code> and <code>nbins==nothing</code>. Example: <code>0.1</code>. </li><li><code>ywidth</code> is like <code>xwidth</code> but for the y-axis corresponding to the provided <code>mags</code> array. Example: <code>0.1</code>.</li></ul></div><a class="docs-sourcelink" target="_blank" href="https://github.com/cgarling/StarFormationHistories.jl/blob/901f1c0f1a50ab9b90658688127cd8c6ecefd2e6/src/StarFormationHistories.jl#L435-L447">source</a></section></article></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../hierarchical/dispersion_models/">« Metallicity Dispersion Models</a><a class="docs-footer-nextpage" href="../kernels/">Kernels »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.11.4 on <span class="colophon-date" title="Sunday 25 May 2025 02:12">Sunday 25 May 2025</span>. Using Julia version 1.11.5.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
