<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Mass-Metallicity Relations (MZRs) · StarFormationHistories.jl</title><meta name="title" content="Mass-Metallicity Relations (MZRs) · StarFormationHistories.jl"/><meta property="og:title" content="Mass-Metallicity Relations (MZRs) · StarFormationHistories.jl"/><meta property="twitter:title" content="Mass-Metallicity Relations (MZRs) · StarFormationHistories.jl"/><meta name="description" content="Documentation for StarFormationHistories.jl."/><meta property="og:description" content="Documentation for StarFormationHistories.jl."/><meta property="twitter:description" content="Documentation for StarFormationHistories.jl."/><script data-outdated-warner src="../../../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../../../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../../../assets/documenter.js"></script><script src="../../../../search_index.js"></script><script src="../../../../siteinfo.js"></script><script src="../../../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../../../../">StarFormationHistories.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../../../">Overview</a></li><li><span class="tocitem">Deriving Star Formation Histories from Hess Diagrams</span><ul><li><a class="tocitem" href="../../../fitting_intro/">Background and Template Construction</a></li><li><a class="tocitem" href="../../../unconstrained/">High-Level Methods for Unconstrained Fitting</a></li><li><input class="collapse-toggle" id="menuitem-2-3" type="checkbox" checked/><label class="tocitem" for="menuitem-2-3"><span class="docs-label">Constrained Metallicity Evolution</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../overview/">Overview</a></li><li><input class="collapse-toggle" id="menuitem-2-3-2" type="checkbox"/><label class="tocitem" for="menuitem-2-3-2"><span class="docs-label">AMRs</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../linear_amr/">Linear Age-Metallicity Relation</a></li><li><a class="tocitem" href="../../log_amr/">Logarithmic Age-Metallicity Relation</a></li><li><a class="tocitem" href="../../fixed_amr/">Fixed Age-Metallicity Relations</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-2-3-3" type="checkbox" checked/><label class="tocitem" for="menuitem-2-3-3"><span class="docs-label">MZRs</span><i class="docs-chevron"></i></label><ul class="collapsed"><li class="is-active"><a class="tocitem" href>Mass-Metallicity Relations (MZRs)</a><ul class="internal"><li><a class="tocitem" href="#Motivation"><span>Motivation</span></a></li><li><a class="tocitem" href="#Built-In-Models"><span>Built-In Models</span></a></li><li><a class="tocitem" href="#mzr_API"><span>Mass-Metallicity Relation API</span></a></li><li><a class="tocitem" href="#Fitting-and-Sampling-Methods"><span>Fitting and Sampling Methods</span></a></li><li><a class="tocitem" href="#mzr_derivation"><span>Derivation</span></a></li><li><a class="tocitem" href="#Case:-jj\\prime"><span>Case: <span>$j=j^\prime$</span></span></a></li><li><a class="tocitem" href="#Case:-j-\\neq-j\\prime"><span>Case: <span>$j \neq j^\prime$</span></span></a></li><li><a class="tocitem" href="#MZR-Parameters"><span>MZR Parameters</span></a></li></ul></li></ul></li><li><a class="tocitem" href="../../dispersion_models/">Metallicity Dispersion Models</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-2-4" type="checkbox"/><label class="tocitem" for="menuitem-2-4"><span class="docs-label">Internals</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../internals/">Low-Level Functions</a></li><li><a class="tocitem" href="../../../kernels/">Kernels</a></li></ul></li></ul></li><li><a class="tocitem" href="../../../../examples/">Examples</a></li><li><a class="tocitem" href="../../../../simulate/">Simulating Color-Magnitude Diagrams</a></li><li><a class="tocitem" href="../../../../binaries/">Binary Systems</a></li><li><a class="tocitem" href="../../../../helpers/">Helper Functions</a></li><li><a class="tocitem" href="../../../../doc_index/">Index</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Deriving Star Formation Histories from Hess Diagrams</a></li><li><a class="is-disabled">Constrained Metallicity Evolution</a></li><li><a class="is-disabled">MZRs</a></li><li class="is-active"><a href>Mass-Metallicity Relations (MZRs)</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Mass-Metallicity Relations (MZRs)</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/cgarling/StarFormationHistories.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/cgarling/StarFormationHistories.jl/blob/main/docs/src/fitting/hierarchical/MZR/MZR.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="MZR"><a class="docs-heading-anchor" href="#MZR">Mass-Metallicity Relations (MZRs)</a><a id="MZR-1"></a><a class="docs-heading-anchor-permalink" href="#MZR" title="Permalink"></a></h1><h2 id="Motivation"><a class="docs-heading-anchor" href="#Motivation">Motivation</a><a id="Motivation-1"></a><a class="docs-heading-anchor-permalink" href="#Motivation" title="Permalink"></a></h2><p>The parametric age-metallicity relations (AMRs) provided by this package are typically sufficient to provide good fits to observed CMDs with very few degrees of freedom. However, they are somewhat arbitrary and unphysical as they have no direct relation to the underlying star formation activity, which is what enrichs the ISM in the first place. As such, physical interpretation of AMRs is dubious – rather, it is often the population-integrated metallicity distribution functions (MDFs) which are compared against external datasets that directly probe stellar metallicities (e.g., single-star spectroscopy).</p><p>As we are simultaneously fitting both the historical star formation rates (SFRs) and the metallicity at which those stars are forming over time, it is possible to design a framework in which the metallicity evolves in a self-consistent way with the star formation activity. As the AMR describes the mean metallicity of stars forming at different times, it should be most directly related to the metallicity evolution of the star-forming ISM. We therefore need to connect the star formation activity to the ISM metallicity.</p><p>This is complicated by the fact that in general one-zone chemical models, both star-formation driven outflows (which deplete the ISM of both metals and HI) and pristine gas inflows (composed majorly of HI which dilutes the metallicity of the ISM) must be modelled. While hydrodynamic simulations can provide predictions of outflow rates (i.e., through mass-loading factors), the inflow rates are time-variable, depend on the local environment, and generally unconstrained observationally on an object-to-object basis. As such, general one-zone chemical models are unattractive for our purposes.</p><p>A more attractive formulation can be found in the idea of an effective yield, which is the fraction of stellar mass that is composed of metals <span>$\gamma = M_{Z,*} / M_*$</span>. As shown by <a href="https://ui.adsabs.harvard.edu/abs/2019MNRAS.484.5587T">Torrey et al. 2019</a>, who measured these yields in the Illustris TNG100 simulation, these yields are primarily a function of total galaxy stellar mass and not of redshift. Therefore, the rate of change of the yield with respect to stellar mass <span>$\frac{\partial \gamma}{\partial M_*}$</span> can be connected to the rate at which metals are accumulated in stars as galaxies grow.</p><p>Further, the existence of the gas-phase mass-metallicity relation (MZR) for star-forming galaxies gives us some empirical guidance for an implementation, as the AMR should be mostly connected to the gas-phase metallicity. While the MZR is mostly unconstrained for the low-mass galaxies that are typically studied in the Local Universe with resolved photometry (<span>$M_* &lt; 10^8 \; \text{M}_\odot$</span>), the MZR is often extrapolated to low masses as a power law in stellar mass.</p><p>While it is known that higher-mass galaxies do not strictly evolve <em>along</em> the MZR, due in large part to the time variability of inflows mentioned above, the simple form of the power law extrapolation of the MZR allows for a simple experiment. If (on average) the ISM metallicity at time <span>$t$</span> is primarily driven by the total stellar mass at that time <span>$M_*(t)$</span>, then a two-parameter MZR (power law slope and intercept) coupled to the SFRs in the SFH fitting process should result in better CMD models than a similar two-parameter AMR (e.g., the <a href="../../linear_amr/#linear_amr_section">linear AMR model</a>) which has no mathematical link to the SFRs. In turn, the best-fit SFRs and population-integrated MDFs should also be more accurate if the modelled AMR is better.</p><p>We provide a generic interface for describing the analytic form of the MZR so that it is easy to define new MZR models that will integrate with our fitting routines. Built-in, ready to use models are described below, and the API for defining new models is described in <a href="../../dispersion_models/#dispersion_API">the API section</a>.</p><h2 id="Built-In-Models"><a class="docs-heading-anchor" href="#Built-In-Models">Built-In Models</a><a id="Built-In-Models-1"></a><a class="docs-heading-anchor-permalink" href="#Built-In-Models" title="Permalink"></a></h2><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="StarFormationHistories.PowerLawMZR" href="#StarFormationHistories.PowerLawMZR"><code>StarFormationHistories.PowerLawMZR</code></a> — <span class="docstring-category">Type</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">PowerLawMZR(α::Real, MH0::Real, logMstar0::Real=6,
            free::NTuple{2, Bool}=(true, true)) &lt;: AbstractMZR</code></pre><p>Mass-metallicity model described by a single power law index <code>α &gt; 0</code>, a metallicity normalization <code>MH0</code>, and the logarithm of the stellar mass <code>logMstar0 = log10(Mstar0 [M⊙])</code> at which the mean metallicity is <code>MH0</code>. Because <code>logMstar0</code> and <code>MH0</code> are degenerate, we treat <code>MH0</code> as a fittable parameter and <code>logMstar0</code> as a fixed parameter that will not be changed during optimizations. Such a power law MZR is often used when extrapolating literature results to low masses, e.g., <span>$\text{M}_* &lt; 10^8 \; \text{M}_\odot.$</span> <code>α</code> will be fit freely during optimizations if <code>free[1] == true</code> and <code>MH0</code> will be fit freely if <code>free[2] == true</code>. The MZR is defined by</p><p class="math-container">\[\begin{aligned}
[\text{M} / \text{H}] \left( \text{M}_* \right) &amp;= [\text{M} / \text{H}]_0 + \text{log} \left( \left( \frac{\text{M}_*}{\text{M}_{*,0}} \right)^\alpha \right) \\
&amp;= [\text{M} / \text{H}]_0 + \alpha \, \left( \text{log} \left( \text{M}_* \right) - \text{log} \left( \text{M}_{*,0} \right) \right) \\
\end{aligned}\]</p><p><strong>Examples</strong></p><pre><code class="language-julia-repl hljs">julia&gt; PowerLawMZR(1.0, -1) isa PowerLawMZR{Float64}
true

julia&gt; import Test

julia&gt; Test.@test_throws(ArgumentError, PowerLawMZR(-1.0, -1)) isa Test.Pass
true

julia&gt; nparams(PowerLawMZR(1.0, -1)) == 2
true

julia&gt; PowerLawMZR(1.0, -1, 6)(1e7) ≈ 0
true

julia&gt; all(values(gradient(PowerLawMZR(1.0, -1, 6), 1e8)) .≈
                (2.0, 1.0, 1 / 1e8 / log(10)))
true

julia&gt; update_params(PowerLawMZR(1.0, -1, 7, (true, false)), (2.0, -2)) ==
         PowerLawMZR(2.0, -2, 7, (true, false))
true

julia&gt; transforms(PowerLawMZR(1.0, -1)) == (1,0)
true

julia&gt; free_params(PowerLawMZR(1.0, -1, 7, (true, false))) == (true, false)
true</code></pre></div><a class="docs-sourcelink" target="_blank" href="https://github.com/cgarling/StarFormationHistories.jl/blob/f58c0b41c1b66f55b12c3cd548ae765f110dec28/src/fitting/hierarchical/mzr.jl#L220-L262">source</a></section></article><p>The per-SSP stellar mass coefficients (<span>$r_{j,k}$</span> in the <a href="#mzr_derivation">derivation</a>) can be derived from an MZR model, a <a href="../../dispersion_models/#dispersion_models">metallicity dispersion model</a>, the per-unique-log(age) stellar mass coefficients (<span>$R_j$</span> in the <a href="#mzr_derivation">derivation</a>), and the set of SSP logarithmic ages <code>logAge = log10(age [yr])</code> and metallicites using <a href="../../overview/#StarFormationHistories.calculate_coeffs"><code>calculate_coeffs</code></a>.</p><h2 id="mzr_API"><a class="docs-heading-anchor" href="#mzr_API">Mass-Metallicity Relation API</a><a id="mzr_API-1"></a><a class="docs-heading-anchor-permalink" href="#mzr_API" title="Permalink"></a></h2><p>Below we describe the API that must be followed in order to implement new types for describing a mass-metallicity relation, such that they will work with our provided fitting and sampling methods.</p><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="StarFormationHistories.AbstractMZR" href="#StarFormationHistories.AbstractMZR"><code>StarFormationHistories.AbstractMZR</code></a> — <span class="docstring-category">Type</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><p><code>AbstractMZR{T &lt;: Real} &lt;: AbstractMetallicityModel{T}</code>: abstract supertype for all metallicity models that are mass-metallicity relations. Concrete subtypes <code>T &lt;: AbstractMZR</code> should implement the following API: </p><ul><li><code>(model::T)(Mstar::Real)</code> should be defined so that the struct is callable with a stellar mass <code>Mstar</code> in solar masses, returning the mean metallicity given the MZR model. This is <span>$\mu_j \left( \text{M}_* \right)$</span> in the derivations presented in the documentation.</li><li><code>nparams(model::T)</code> should return the number of fittable parameters in the model.</li><li><code>fittable_params(model::T)</code> should return the values of the fittable parameters in the model.</li><li><code>gradient(model::T, Mstar::Real)</code> should return a tuple that contains the partial derivative of the mean metallicity <span>$\mu_j$</span> with respect to each fittable model parameter, plus the partial derivative with respect to the stellar mass <code>Mstar</code> as the final element.</li><li><code>update_params(model::T, newparams)</code> should return a new instance of <code>T</code> with the fittable parameters contained in <code>newparams</code> (which is typically a vector or tuple) and non-fittable parameters inherited from the provided <code>model</code>.</li><li><code>transforms(model::T)</code> should return a tuple of length <code>nparams(model)</code> which indicates how the fittable variables should be transformed for optimization, if at all. Elements should be <code>1</code> for parameters that are constrained to always be positive, <code>0</code> for parameters that can be positive or negative, and <code>-1</code> for parameters that are constrained to always be negative.</li><li><code>free_params(model::T)</code> should return an <code>NTuple{nparams(model), Bool}</code> that is <code>true</code> for fittable parameters that you want to optimize and <code>false</code> for fittable parameters that you want to stay fixed during optimization. </li></ul></div><a class="docs-sourcelink" target="_blank" href="https://github.com/cgarling/StarFormationHistories.jl/blob/f58c0b41c1b66f55b12c3cd548ae765f110dec28/src/fitting/hierarchical/mzr.jl#L6-L14">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="StarFormationHistories.nparams-Tuple{StarFormationHistories.AbstractMZR}" href="#StarFormationHistories.nparams-Tuple{StarFormationHistories.AbstractMZR}"><code>StarFormationHistories.nparams</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">nparams(model::AbstractMZR)::Int</code></pre><p>Returns the number of fittable parameters in the model. </p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/cgarling/StarFormationHistories.jl/blob/f58c0b41c1b66f55b12c3cd548ae765f110dec28/src/fitting/hierarchical/mzr.jl#L16-L19">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="StarFormationHistories.fittable_params-Tuple{StarFormationHistories.AbstractMZR}" href="#StarFormationHistories.fittable_params-Tuple{StarFormationHistories.AbstractMZR}"><code>StarFormationHistories.fittable_params</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">fittable_params(model::AbstractMZR{T})::NTuple{nparams(model), T}</code></pre><p>Returns the values of the fittable parameters in the provided MZR <code>model</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/cgarling/StarFormationHistories.jl/blob/f58c0b41c1b66f55b12c3cd548ae765f110dec28/src/fitting/hierarchical/mzr.jl#L21-L24">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="StarFormationHistories.gradient-Tuple{StarFormationHistories.AbstractMZR, Real}" href="#StarFormationHistories.gradient-Tuple{StarFormationHistories.AbstractMZR, Real}"><code>StarFormationHistories.gradient</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">gradient(model::AbstractMZR{T}, Mstar::Real)::NTuple{nparams(model)+1, T}</code></pre><p>Returns a tuple containing the partial derivative of the mean metallicity with respect to all fittable parameters, plus the partial derivative with respect to the stellar mass <code>Mstar</code> as the final element. These partial derivatives are evaluated at stellar mass <code>Mstar</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/cgarling/StarFormationHistories.jl/blob/f58c0b41c1b66f55b12c3cd548ae765f110dec28/src/fitting/hierarchical/mzr.jl#L26-L29">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="StarFormationHistories.update_params-Tuple{StarFormationHistories.AbstractMZR, Any}" href="#StarFormationHistories.update_params-Tuple{StarFormationHistories.AbstractMZR, Any}"><code>StarFormationHistories.update_params</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">update_params(model::T, newparams)::T where {T &lt;: AbstractMZR}</code></pre><p>Returns a new instance of the model type <code>T</code> with the fittable parameters contained in <code>newparams</code> (which is typically a vector or tuple), with non-fittable parameters inherited from the provided <code>model</code>. </p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/cgarling/StarFormationHistories.jl/blob/f58c0b41c1b66f55b12c3cd548ae765f110dec28/src/fitting/hierarchical/mzr.jl#L31-L34">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="StarFormationHistories.transforms-Tuple{StarFormationHistories.AbstractMZR}" href="#StarFormationHistories.transforms-Tuple{StarFormationHistories.AbstractMZR}"><code>StarFormationHistories.transforms</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">transforms(model::AbstractMZR)::NTuple{nparams(model), Int}</code></pre><p>Returns a tuple of length <code>nparams(model)</code> which indicates how the fittable variables should be transformed for optimization, if at all. Elements should be <code>1</code> for parameters that are constrained to always be positive, <code>0</code> for parameters that can be positive or negative, and <code>-1</code> for parameters that are constrained to always be negative.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/cgarling/StarFormationHistories.jl/blob/f58c0b41c1b66f55b12c3cd548ae765f110dec28/src/fitting/hierarchical/mzr.jl#L36-L39">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="StarFormationHistories.free_params-Tuple{StarFormationHistories.AbstractMZR}" href="#StarFormationHistories.free_params-Tuple{StarFormationHistories.AbstractMZR}"><code>StarFormationHistories.free_params</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">free_params(model::AbstractMZR)::NTuple{nparams(model), Bool}</code></pre><p>Returns an tuple of length <code>nparams(model)</code> that is <code>true</code> for fittable parameters that you want to optimize and <code>false</code> for fittable parameters that you want to stay fixed during optimization.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/cgarling/StarFormationHistories.jl/blob/f58c0b41c1b66f55b12c3cd548ae765f110dec28/src/fitting/hierarchical/mzr.jl#L41-L44">source</a></section></article><h2 id="Fitting-and-Sampling-Methods"><a class="docs-heading-anchor" href="#Fitting-and-Sampling-Methods">Fitting and Sampling Methods</a><a id="Fitting-and-Sampling-Methods-1"></a><a class="docs-heading-anchor-permalink" href="#Fitting-and-Sampling-Methods" title="Permalink"></a></h2><p>The MZRs listed above support the generic fitting and sampling methods listed in the <a href="../../overview/#metal_evo_intro">overview</a>.</p><h2 id="mzr_derivation"><a class="docs-heading-anchor" href="#mzr_derivation">Derivation</a><a id="mzr_derivation-1"></a><a class="docs-heading-anchor-permalink" href="#mzr_derivation" title="Permalink"></a></h2><p>We once again wish to derive the gradient of the objective function with respect to the fitting parameters to enable gradient-based optimization. Our derivation will reuse some of the notation developed in the section on the <a href="../../linear_amr/#linear_amr_section">linear AMR</a>. The main difference is that instead of expressing the mean metallicity as a function of time <span>$\langle [\text{M}/\text{H}] \rangle (t)$</span>, with an MZR we express the mean metallicity as a function of stellar mass at that time <span>$\langle [\text{M}/\text{H}] \rangle (\text{M}_*(t))$</span>. This means that the partial derivatives of the objective with respect to the stellar mass coefficients have a more complex form than in the AMR case, as changing the stellar mass formed 10 Gyr ago (for example) would change the total stellar mass at all more recent times, which in turn changes the mean metallicity expected at all more recent times.</p><p>In the derivations for AMRs we were agnostic about the choice of template normalization; templates could either be normalized to have units of expected number of stars per solar mass of stars formed <span>$[N / \text{M}_\odot]$</span>, or expected number of stars per unit star formation rate <span>$[N / \dot{\text{M}}_\odot]$</span>. Changing the units of the templates would, in turn, change the units of the fitting variables returned by the fitting routines, but as shown in our example Jupyter notebook, the fit results are the same no matter the choice of fitting units. For an MZR, we <em>must</em> know the units of the templates and fitting variables so that we may properly calculate the total cumulative stellar mass as a function of time. <em>For simplicity, we assume templates are normalized to number of stars per solar mass of stars formed <span>$[N / \text{M}_\odot]$</span> and that the fitting variables are therefore the total stellar mass ascribed to each time bin – this is the default behavior for the template creation routines.</em></p><p>Borrowing notation from <a href="../../../fitting_intro/#fitting">the fitting introduction</a> and the <a href="../../linear_amr/#linear_amr_section">section on linear AMRs</a>, the bin <span>$m_i$</span> of the complex model Hess diagram can be written as the sum over the grid of templates with ages indexed by <span>$j$</span> and metallicities indexed by <span>$k$</span> as</p><p class="math-container">\[m_i = \sum_{j,k} \, r_{j,k} \; c_{i,j,k}\]</p><p>where <span>$m_i$</span> is the value of the complex model in bin <span>$i$</span>, <span>$c_{i,j,k}$</span> is the value of the SSP template with age <span>$j$</span> and metallicity <span>$k$</span> in bin <span>$i$</span>, and <span>$r_{j,k}$</span> is the multiplicative coefficient determining how significant the template is to the complex population.</p><p>The gradient of the objective with respect to the <span>$r_{j,k}$</span> is given by Equation 21 in Dolphin 2001 as shown in the <a href="../../linear_amr/#linear_amr_section">section on linear AMRs</a>,</p><p class="math-container">\[\begin{aligned}
F \equiv - \text{ln} \, \mathscr{L} &amp;= \sum_i m_i - n_i \times \left( 1 - \text{ln} \, \left( \frac{n_i}{m_i} \right) \right) \\
\frac{\partial \, F}{\partial \, r_{j,k}} &amp;= \sum_i c_{i,j,k} \left( 1 - \frac{n_i}{m_i} \right)
\end{aligned}\]</p><p>where <span>$n_i$</span> is bin <span>$i$</span> of the observed Hess diagram. These partial derivatives are easy to obtain, but we need partials with respect to the total stellar mass formed at each distinct age, <span>$R_j$</span>. These are more complicated that the same partial derivatives under an AMR model.</p><p>For the purposes of illustration, we will consider a power law MZR with slope <span>$\alpha$</span> as is typically used to describe the extrapolation of gas-phase MZRs to masses below <span>$10^8 \text{M}_\odot$</span>. Under this model, we can express the mean metallicity at time <span>$j$</span>, notated as <span>$\mu_j$</span>, as</p><p class="math-container">\[\begin{aligned}
\mu_j &amp;= [\text{M}/\text{H}]_0 + \text{log} \left( \left( \frac{\text{M}_* (t_j)}{\text{M}_0} \right)^\alpha \right) \\
&amp;= [\text{M}/\text{H}]_0 + \alpha \, \left( \text{log} \left( \text{M}_* (t_j) \right) - \text{log} \left( \text{M}_0 \right) \right) \\
\end{aligned}\]</p><p>where the power law MZR is normalized such that the mean metallicity is <span>$[\text{M}/\text{H}]_0$</span> at stellar mass <span>$\text{M}_0$</span>. Note that the MZR comes linear with slope <span>$\alpha$</span> when expressed in <span>$\text{log}(\text{M}_*)$</span>. As in the AMR models, we use a Gaussian to introduce some metallicity dispersion at fixed time, such that the <span>$r_{j,k}$</span> are</p><p class="math-container">\[\begin{aligned}
r_{j,k} &amp;= R_j \, \frac{ \text{exp} \left( - \frac{1}{2} \left( \frac{ [\text{M}/\text{H}]_k - \mu_j}{\sigma} \right)^2 \right)}{\sum_k \text{exp} \left( - \frac{1}{2} \left( \frac{ [\text{M}/\text{H}]_k - \mu_j}{\sigma} \right)^2 \right)} \\
A_{j,k} &amp;= \text{exp} \left( - \frac{1}{2} \left( \frac{ [\text{M}/\text{H}]_k - \mu_j}{\sigma} \right)^2 \right) \\
r_{j,k} &amp;= R_j \, \frac{A_{j,k}}{\sum_k A_{j,k}} \\
\end{aligned}\]</p><p>where the <span>$R_j$</span> are the fitting variables representing the total stellar mass formed at each distinct age in the template grid. We define <span>$A_{j,k}$</span> to substitute in for the broadening PDF, as the Gaussian could easily be substituted for other forms with minimal changes to the derivation. The three parameters in the MZR model are therefore the power law slope <span>$\alpha$</span>, a normalization/intercept parameter <span>$[\text{M}/\text{H}]_0$</span>, and the metallicity broadening parameter <span>$\sigma$</span>; this is the same number of parameters as in the linear AMR model.</p><p>We can write the partial derivative of the objective <span>$F$</span> with respect to the <span>$R_j$</span> as</p><p class="math-container">\[\frac{\partial \, F}{\partial \, R_j} = \sum_k \sum_{j^\prime} \, \frac{\partial \, F}{\partial \, r_{j^\prime,k}} \, \frac{\partial \, r_{j^\prime,k}}{\partial \, R_j}\]</p><p>which involves the double sum over the metallicity index <span>$k$</span> and the age index <span>$j^\prime$</span>. In the case of the AMR models, the second term <span>$\frac{\partial \, r_{j^\prime,k}}{\partial \, R_j}$</span> is always 0 for <span>$j^\prime \neq j$</span>, so the equation can be simplified to <span>$\sum_k \, \frac{\partial \, F}{\partial \, r_{j,k}} \, \frac{\partial \, r_{j,k}}{\partial \, R_j}$</span>. As the per-model coefficients <span>$r_{j^\prime,k}$</span> can now depend on the per-age-bin stellar mass coefficients <span>$R_j$</span> through the stellar mass dependence of the mean metallicity at time <span>$\mu_{j^\prime}$</span>, we cannot reduce the sum over <span>$j^\prime$</span>.</p><p>We can, however, simplify the sum over <span>$j^\prime$</span> somewhat. Let the <span>$R_j$</span> be sorted in order from earliest time <span>$t_j$</span> (i.e., largest lookback time) to most recent time (i.e., lowest lookback time). The cumulative stellar mass <span>$\text{M}_* \left( t_j \right)$</span> can therefore be expressed as the sum over the <span>$R_{j^\prime}$</span> for which <span>$j^\prime \leq j$</span>, such that</p><p class="math-container">\[\begin{aligned}
\text{M}_* \left( t_j \right) &amp;= \sum_{j^\prime=0}^{j^\prime=j} R_{j^\prime} \\
\frac{\partial \, \text{M}_* \left( t_j \right)}{\partial R_j} &amp;= 1 \\
\end{aligned}\]</p><p>As the <span>$R_j$</span> dependence on the <span>$r_{j^\prime,k}$</span> enters through the cumulative stellar mass <span>$\text{M}_* \left( t_{j^\prime} \right)$</span>, it is clear that the <span>$r_{j^\prime,k}$</span> will depend only on the <span>$R_j$</span> for which <span>$t_j$</span> is earlier than <span>$t_{j^\prime}$</span>. Given the above sorting of the <span>$R_j$</span>, we can write the sum as</p><p class="math-container">\[\begin{aligned}
\frac{\partial \, F}{\partial \, R_j} &amp;= \sum_k \sum_{j^\prime=0}^j \, \frac{\partial \, F}{\partial \, r_{j^\prime,k}} \, \frac{\partial \, r_{j^\prime,k}}{\partial \, R_j} \\
&amp;= \sum_k \left( \frac{\partial \, F}{\partial \, r_{j,k}} \, \frac{\partial \, r_{j,k}}{\partial \, R_j} + \sum_{j^\prime=0}^{j-1} \, \frac{\partial \, F}{\partial \, r_{j^\prime,k}} \, \frac{\partial \, r_{j^\prime,k}}{\partial \, R_j} \right) \\
\end{aligned}\]</p><p>where the second line splits out the case for <span>$j^\prime = j$</span> from the sum over <span>$j^\prime$</span> as this case involves terms not involved when <span>$j^\prime \neq j$</span>.</p><h2 id="Case:-jj\\prime"><a class="docs-heading-anchor" href="#Case:-jj\\prime">Case: <span>$j=j^\prime$</span></a><a id="Case:-jj\\prime-1"></a><a class="docs-heading-anchor-permalink" href="#Case:-jj\\prime" title="Permalink"></a></h2><p>Applying the product rule twice,</p><p class="math-container">\[\begin{aligned}
r_{j,k} &amp;= R_j \, \frac{A_{j,k}}{\sum_k A_{j,k}} \\
\frac{\partial \, r_{j,k}}{\partial \, R_j} &amp;= \frac{A_{j,k}}{\sum_k A_{j,k}} + R_j \, \left( \frac{\frac{\partial \, A_{j,k}}{\partial \, R_j}}{\sum_k A_{j,k}} - \frac{A_{j,k} \, \frac{\partial \, \sum_k A_{j,k}}{\partial \, R_j}}{\left(\sum_k A_{j,k}\right)^2} \right) \\
\end{aligned}\]</p><p>In AMR models, the term in parentheses on the right hand side is zero as the partial derivatives of all <span>$A_{j,k}$</span> with respect to the stellar mass coefficients <span>$R_j$</span> are zero. These terms are new for the MZR model, as <span>$A_{j,k}$</span> depends on <span>$\mu_j$</span> which depends on the <span>$R_j$</span> through the total stellar mass formed by time <span>$t_j$</span>. </p><p>The first term can be replaced by an equivalent expression which is often more convenient: <span>$\frac{A_{j,k}}{\sum_k A_{j,k}} = \frac{r_{j,k}}{R_j}$</span>. The term <span>$\frac{\partial \, \sum_k A_{j,k}}{\partial \, R_j}$</span> can be replaced by noting that the partial derivative with respect to <span>$R_j$</span> of the sum over <span>$k$</span> of the <span>$A_{j,k}$</span> must be equal to the sum over <span>$k$</span> of the partial derivatives of the individual <span>$A_{j,k}$</span> with respect to <span>$R_j$</span> such that the following equivalency holds true: <span>$\frac{\partial \, \sum_k A_{j,k}}{\partial \, R_j} = \sum_k \frac{\partial \, A_{j,k}}{\partial R_j}$</span>. We therefore have</p><p class="math-container">\[\begin{aligned}
\frac{\partial \, r_{j,k}}{\partial \, R_j} &amp;= \frac{A_{j,k}}{\sum_k A_{j,k}} + R_j \, \left( \frac{\frac{\partial \, A_{j,k}}{\partial \, R_j}}{\sum_k A_{j,k}} - \frac{A_{j,k} \, \frac{\partial \, \sum_k A_{j,k}}{\partial \, R_j}}{\left(\sum_k A_{j,k}\right)^2} \right) \\
&amp;= \frac{r_{j,k}}{R_j} + R_j \, \left( \frac{\frac{\partial \, A_{j,k}}{\partial \, R_j}}{\sum_k A_{j,k}} - \frac{A_{j,k} \, \sum_k \frac{\partial \, A_{j,k}}{\partial \, R_j}}{\left(\sum_k A_{j,k}\right)^2} \right) \\
&amp;= \frac{r_{j,k}}{R_j} + \frac{R_j}{\sum_k A_{j,k}} \left( \frac{\partial \, A_{j,k}}{\partial \, R_j} - \frac{A_{j,k} \, \sum_k \frac{\partial \, A_{j,k}}{\partial \, R_j}}{\sum_k A_{j,k}} \right) \\
\end{aligned}\]</p><p>We now need to formulate the partial derivatives of the dispersion weights with respect to the stellar mass coefficients, <span>$\frac{\partial \, A_{j,k}}{\partial \, R_j}$</span>. The dependence of the <span>$A_{j,k}$</span> on the <span>$R_j$</span> is manifested through the dependence of the <span>$A_{j,k}$</span> on <span>$\mu_j$</span>, which itself is dependent on the <span>$R_j$</span>. We will assume the <span>$\mu_j$</span> for all general MZR models can be expressed as a function of the stellar mass at time <span>$t_j$</span>, which we denote <span>$\text{M}_* \left( t_j \right)$</span>, and that the stellar mass depends on the <span>$R_j$</span>. Applying the chain rule,</p><p class="math-container">\[\begin{aligned}
\frac{\partial \, A_{j,k}}{\partial \, R_j} &amp;= \frac{\partial \, A_{j,k}}{\partial \, \mu_j} \frac{\partial \, \mu_j}{\partial \, R_j} \\
\frac{\partial \, \mu_j}{\partial \, R_j} &amp;= \frac{\partial \, \mu_j}{\partial \, \text{M}_* \left( t_j \right)} \, \frac{\partial \, \text{M}_* \left( t_j \right)}{\partial R_j} \\
\end{aligned}\]</p><p>In the case that the <span>$R_j$</span> represent the amount of stellar mass formed in time bin <span>$t_j$</span>, then the second term reduces to 1. Let the <span>$R_j$</span> be sorted in order from earliest time <span>$t_j$</span> (i.e., largest lookback time) to most recent time (i.e., lowest lookback time). The cumulative stellar mass <span>$\text{M}_* \left( t_j \right)$</span> can therefore be expressed as the sum over the <span>$R_{j^\prime}$</span> for <span>$j^\prime \leq j$</span>, such that</p><p class="math-container">\[\begin{aligned}
\text{M}_* \left( t_j \right) &amp;= \sum_{j^\prime=0}^{j^\prime=j} R_{j^\prime} \\
\frac{\partial \, \text{M}_* \left( t_j \right)}{\partial R_j} &amp;= 1 \\
\end{aligned}\]</p><p>We can therefore make the simplification</p><p class="math-container">\[\begin{aligned}
\frac{\partial \, \mu_j}{\partial \, R_j} &amp;= \frac{\partial \, \mu_j}{\partial \, \text{M}_* \left( t_j \right)} \, \frac{\partial \, \text{M}_* \left( t_j \right)}{\partial R_j} \\
&amp;= \frac{\partial \, \mu_j}{\partial \, \text{M}_* \left( t_j \right)}
\end{aligned}\]</p><p>so that the partial derivatives of the <span>$A_{j,k}$</span> with respect to the <span>$R_j$</span> become</p><p class="math-container">\[\begin{aligned}
\frac{\partial \, A_{j,k}}{\partial \, R_j} &amp;= \frac{\partial \, A_{j,k}}{\partial \, \mu_j} \frac{\partial \, \mu_j}{\partial \, R_j} \\
&amp;= \frac{\partial \, A_{j,k}}{\partial \, \mu_j} \frac{\partial \, \mu_j}{\partial \, \text{M}_* \left( t_j \right)} \\
\end{aligned}\]</p><p>The forms of these partials will depend on the choices of the metallicity dispersion profile at fixed time, which sets the first term involving <span>$A_{j,k}$</span>, as well as the form of the MZR model which will set the partial derivative of the mean metallicity at time <span>$j$</span>, <span>$\mu_j$</span>, with respect to the cumulative stellar mass at time <span>$t_j$</span>. For our choice of a Gaussian metallicity dispersion profile at fixed time we have</p><p class="math-container">\[\begin{aligned}
A_{j,k} &amp;= \text{exp} \left( - \frac{1}{2} \left( \frac{ [\text{M}/\text{H}]_k - \mu_j}{\sigma} \right)^2 \right) \\
\frac{\partial \, A_{j,k}}{\partial \, \mu_j} &amp;= \frac{A_{j,k}}{\sigma^2} \left( [\text{M}/\text{H}]_k - \mu_j \right) \\
\end{aligned}\]</p><p>and for our choice of a power law MZR we have</p><p class="math-container">\[\begin{aligned}
\mu_j &amp;= [\text{M}/\text{H}]_0 + \alpha \, \left( \text{log} \left( \text{M}_* (t_j) \right) - \text{log} \left( \text{M}_0 \right) \right) \\
\frac{\partial \, \mu_j}{\partial \, \text{M}_* \left( t_j \right)} &amp;= \frac{\alpha}{\text{M}_* \left( t_j \right) \, \text{ln} \, 10} \\
\end{aligned}\]</p><p>such that we now have all the terms we need to compute the <span>$\frac{\partial \, r_{j,k}}{\partial \, R_j}$</span> which enables us to compute the partial derivatives of the objective with respect to the <span>$R_j$</span>, <span>$\frac{\partial \, F}{\partial \, R_j} = \sum_k \, \frac{\partial \, F}{\partial \, r_{j,k}} \, \frac{\partial \, r_{j,k}}{\partial \, R_j}$</span>.</p><h2 id="Case:-j-\\neq-j\\prime"><a class="docs-heading-anchor" href="#Case:-j-\\neq-j\\prime">Case: <span>$j \neq j^\prime$</span></a><a id="Case:-j-\\neq-j\\prime-1"></a><a class="docs-heading-anchor-permalink" href="#Case:-j-\\neq-j\\prime" title="Permalink"></a></h2><p>In the case that <span>$j \neq j^\prime$</span>, the only dependence of the <span>$r_{j^\prime,k}$</span> on the <span>$R_j$</span> comes through the metallicity dispersion coefficients <span>$A_{j^\prime,k}$</span>, which depend on the mean metallicities <span>$\mu_{j^\prime}$</span>, which depend on the cumulative stellar masses <span>$\text{M}_* \left( t_{j^\prime} \right)$</span>, which depend on the <span>$R_j$</span>. Applying the product rule,</p><p class="math-container">\[\begin{aligned}
r_{j^\prime,k} &amp;= R_{j^\prime} \, \frac{A_{j^\prime,k}}{\sum_k A_{j^\prime,k}} \\
\frac{\partial \, r_{j^\prime,k}}{\partial \, R_j} &amp;= R_{j^\prime} \, \left( \frac{\frac{\partial \, A_{j^\prime,k}}{\partial \, R_j}}{\sum_k A_{j^\prime,k}} - \frac{A_{j^\prime,k} \, \frac{\partial \, \sum_k A_{j^\prime,k}}{\partial \, R_j}}{\left(\sum_k A_{j^\prime,k}\right)^2} \right) \\
&amp;= \frac{R_{j^\prime}}{\sum_k A_{j^\prime,k}} \left( \frac{\partial \, A_{j^\prime,k}}{\partial \, R_j} - \frac{A_{j^\prime,k} \, \sum_k \frac{\partial A_{j^\prime,k}}{\partial R_j}}{\sum_k A_{j^\prime,k}} \right) \\
\end{aligned}\]</p><p>which is very similar to the expression found for <span>$j = j^\prime$</span>, except missing the additive prefactor of <span>$\frac{r_{j,k}}{R_j}$</span>. Generally we need to derive the <span>$\frac{\partial A_{j^\prime,k}}{\partial R_j}$</span>, which will follow much the same path as the derivation of <span>$\frac{\partial A_{j,k}}{\partial R_j}$</span> above. We will therefore borrow expressions derived for the case of <span>$j = j^\prime$</span> and alter them to be applicable to the case of <span>$j \neq j^\prime$</span>.</p><p class="math-container">\[\begin{aligned}
\frac{\partial \, A_{j^\prime,k}}{\partial \, R_j} &amp;= \frac{\partial \, A_{j^\prime,k}}{\partial \, \mu_{j^\prime}} \frac{\partial \, \mu_{j^\prime}}{\partial \, R_j} \\
\frac{\partial \, \mu_{j^\prime}}{\partial \, R_j} &amp;= \frac{\partial \, \mu_{j^\prime}}{\partial \, \text{M}_* \left( t_{j^\prime} \right)} \, \frac{\partial \, \text{M}_* \left( t_{j^\prime} \right)}{\partial R_j} \\
\end{aligned}\]</p><p>We will assume as above that the <span>$R_j$</span> represent the amount of stellar mass formed in time bin <span>$t_j$</span> so that the second term is 1 if <span>$t_j$</span> is earlier than <span>$t_{j^\prime}$</span> and 0 if it is later. This follows from our definition of the cumulative stellar mass from above. We can therefore make the simplification</p><p class="math-container">\[\frac{\partial \, \text{M}_* \left( t_{j^\prime} \right)}{\partial R_j} = \Theta \left( j^\prime - j \right)\]</p><p>where <span>$\Theta \left( x \right)$</span> is the Heaviside function, which is one if <span>$x &gt; 0$</span> and zero if <span>$x &lt; 0$</span>. This allows us to write</p><p class="math-container">\[\begin{aligned}
\frac{\partial \, \mu_{j^\prime}}{\partial \, R_j} &amp;= \frac{\partial \, \mu_{j^\prime}}{\partial \, \text{M}_* \left( t_{j^\prime} \right)} \, \frac{\partial \, \text{M}_* \left( t_{j^\prime} \right)}{\partial R_j} \\
&amp;= \frac{\partial \, \mu_{j^\prime}}{\partial \, \text{M}_* \left( t_{j^\prime} \right)} \, \Theta \left( j^\prime - j \right) \\
\end{aligned}\]</p><p>Under our assumption that the <span>$R_j$</span> are ordered from earliest times to latest times, if <span>$j^\prime &lt; j$</span>, then the <span>$R_j$</span> represents stellar mass formed more recently than <span>$t_{j^\prime}$</span>, such that it does not contribute to determining the mean metallicity <span>$\mu_{j^\prime}$</span> and this term will be zero. For a concrete example, consider the lookback times in Gyr of <code>t_j = [13, 12, 11]</code>. If we set <span>$j=0$</span> and <span>$j^\prime=1$</span>, then <span>$\Theta \left( j^\prime - j \right) = 1$</span> as <span>$R_j$</span> represents stellar mass forming 13 Gyr ago, before <span>$t_{j^\prime}$</span> which is 12 Gyr ago – therefore, <span>$R_j$</span> must contribute to the total stellar mass at the later time. In contrast, if we reverse this to <span>$j=1$</span> and <span>$j^\prime=0$</span>, now <span>$\Theta \left( j^\prime - j \right) = 0$</span> because the stellar mass forming at time <span>$t_j$</span>, a lookback time of 12 Gyr, does not affect the cumulative stellar mass at time <span>$t_{j^\prime}$</span>, which is 13 Gyr ago.</p><p>We can now write the partial derivatives of the <span>$A_{j^\prime,k}$</span> with respect to the <span>$R_j$</span> as</p><p class="math-container">\[\begin{aligned}
\frac{\partial \, A_{j^\prime,k}}{\partial \, R_j} &amp;= \frac{\partial \, A_{j^\prime,k}}{\partial \, \mu_j^\prime} \frac{\partial \, \mu_{j^\prime}}{\partial \, R_j} \\
&amp;= \frac{\partial \, A_{j^\prime,k}}{\partial \, \mu_{j^\prime}} \frac{\partial \, \mu_{j^\prime}}{\partial \, \text{M}_* \left( t_{j^\prime} \right)} \, \Theta \left( j^\prime - j \right) \\
\end{aligned}\]</p><p>These partial derivatives must be calculated for your choice of metallicity dispersion profile at fixed time, which sets the first term involving <span>$A_{j,k}$</span>, and MZR model, which will set the partial derivative of <span>$\mu_{j^\prime}$</span> (the mean metallicity at time <span>$j^\prime$</span>) with respect to the cumulative stellar mass at time <span>$t_{j^\prime}$</span>. For our choice of a Gaussian metallicity dispersion profile at fixed time we have</p><p class="math-container">\[\begin{aligned}
A_{j^\prime,k} &amp;= \text{exp} \left( - \frac{1}{2} \left( \frac{ [\text{M}/\text{H}]_k - \mu_{j^\prime}}{\sigma} \right)^2 \right) \\
\frac{\partial \, A_{j^\prime,k}}{\partial \, \mu_{j^\prime}} &amp;= \frac{A_{j^\prime,k}}{\sigma^2} \left( [\text{M}/\text{H}]_k - \mu_{j^\prime} \right) \\
\end{aligned}\]</p><p>and for our choice of a power law MZR we have</p><p class="math-container">\[\begin{aligned}
\mu_{j^\prime} &amp;= [\text{M}/\text{H}]_0 + \alpha \, \left( \text{log} \left( \text{M}_* (t_{j^\prime}) \right) - \text{log} \left( \text{M}_0 \right) \right) \\
\frac{\partial \, \mu_{j^\prime}}{\partial \, \text{M}_* \left( t_{j^\prime} \right)} &amp;= \frac{\alpha}{\text{M}_* \left( t_{j^\prime} \right) \, \text{ln} \, 10} \\
\end{aligned}\]</p><p>such that we now have all the terms we need to compute the <span>$\frac{\partial \, r_{{j^\prime},k}}{\partial \, R_j}$</span> for both <span>$j^\prime = j$</span> and <span>$j^\prime \neq j$</span>, which enables us to compute the partial derivatives of the objective with respect to the <span>$R_j$</span>, <span>$\frac{\partial \, F}{\partial \, R_j}$</span>.</p><h2 id="MZR-Parameters"><a class="docs-heading-anchor" href="#MZR-Parameters">MZR Parameters</a><a id="MZR-Parameters-1"></a><a class="docs-heading-anchor-permalink" href="#MZR-Parameters" title="Permalink"></a></h2><p>Above we have derived the partial derivatives of the objective with respect to the stellar mass coefficients <span>$\frac{\partial \, F}{\partial \, R_j}$</span>. It remains to derive the partial derivatives of the objective with respect to the parameters that define the MZR. In the case of our power law MZR example, the two parameters of interest are the power law slope <span>$\alpha$</span> and the metallicity normalization parameter <span>$[\text{M}/\text{H}]_0$</span>, which is the metallicity at a stellar mass of <span>$\text{M}_0$</span> – the exact value of <span>$\text{M}_0$</span> is not of interest and is treated as fixed.</p><p class="math-container">\[\mu_{j} = \beta + \alpha \, \left( \text{log} \left( \text{M}_* (t_{j}) \right) - \text{log} \left( \text{M}_0 \right) \right) \\\]</p><p>Note that the power law MZR example, as defined, is linear in <span>$\text{log} \left( \text{M}_* \right)$</span>, so that it can be written analogously to the <a href="../../linear_amr/#linear_amr_section">linear AMR case</a>. The forms of the partial derivatives are therefore similar. For simplicity of notation, and to highlight the similarity with the linear AMR model, we will write <span>$\beta \equiv [\text{M}/\text{H}]_0$</span> as it is also a normalization parameter as <span>$\beta$</span> is in the linear AMR case. </p><p>The first part of the derivation is then the same as the linear AMR case,</p><p class="math-container">\[\begin{aligned}
\frac{\partial \, F}{\partial \, \beta} &amp;= \sum_{j,k} \frac{\partial \, F}{\partial \, r_{j,k}} \, \frac{\partial \, r_{j,k}}{\partial \, \beta} \\
\frac{\partial \, r_{j,k}}{\partial \, \beta} &amp;= R_j \left( \frac{1}{\sum_k \, A_{j,k}} \, \frac{\partial \, A_{j,k}}{\partial \, \beta} - \frac{A_{j,k}}{\left( \sum_k \, A_{j,k} \right)^2} \, \frac{\partial \, \sum_k \, A_{j,k}}{\partial \, \beta} \right)  \\
&amp;= \frac{R_j}{\sum_k \, A_{j,k}} \left( \frac{\partial \, A_{j,k}}{\partial \, \beta} - \frac{A_{j,k}}{\sum_k \, A_{j,k}} \sum_k \frac{\partial \, A_{j,k}}{\partial \, \beta} \right) \\
\end{aligned}\]</p><p>Our definition for the <span>$A_{j,k}$</span> are also the same, assuming a small Gaussian dispersion in metallicity at fixed time. </p><p class="math-container">\[\begin{aligned}
\frac{\partial \, A_{j,k}}{\partial \, \beta} &amp;= \frac{\partial \, A_{j,k}}{\partial \, \mu_j} \frac{\partial \mu_j}{\partial \beta} = \frac{\partial \, A_{j,k}}{\partial \, \mu_j} \\
\frac{\partial \, A_{j,k}}{\partial \, \beta} &amp;= \frac{\partial}{\partial \, \mu} \, \left[ \text{exp} \left( - \frac{1}{2} \left( \frac{ [\text{M}/\text{H}]_k - \mu_j}{\sigma} \right)^2 \right) \right] \\
&amp;= \frac{A_{j,k}}{\sigma^2} \left( [\text{M}/\text{H}]_k - \mu_j \right) \\
\end{aligned}\]</p><p>which, as expected, is the same result as in the linear AMR case, as <span>$\beta$</span> is a intercept (or normalization parameter) in both models. The partial derivative with respect to the slope <span>$\alpha$</span> can be expanded similarly,</p><p class="math-container">\[\frac{\partial \, A_{j,k}}{\partial \, \alpha} = \frac{\partial \, A_{j,k}}{\partial \, \mu_j} \frac{\partial \mu_j}{\partial \alpha}\]</p><p>As in the linear AMR case, it can be shown that the partial derivative of the objective with respect to <span>$\alpha$</span> is simply</p><p class="math-container">\[\frac{\partial \, F}{\partial \, \alpha} = \sum_{j,k} \frac{\partial \, F}{\partial \, r_{j,k}} \, \frac{\partial \, r_{j,k}}{\partial \, \alpha} = \sum_{j,k} \frac{\partial \, F}{\partial \, r_{j,k}} \, \frac{\partial \, r_{j,k}}{\partial \, \beta} \times \left( \text{log} \left( \text{M}_* (t_{j}) \right) - \text{log} \left( \text{M}_0 \right) \right) \\\]</p><p>More generally, for any parameter <span>$P$</span> that is used to calculate the mean metallicity <span>$\mu_j$</span>, we can write the partial derivative of the objective with respect to <span>$P$</span> as</p><p class="math-container">\[\begin{aligned}
\frac{\partial \, F}{\partial \, P} &amp;= \sum_{j,k} \frac{\partial \, F}{\partial \, r_{j,k}} \, \frac{\partial \, r_{j,k}}{\partial \, P} \\
\frac{\partial \, r_{j,k}}{\partial \, P} &amp;= \frac{R_j}{\sum_k \, A_{j,k}} \left( \frac{\partial \, A_{j,k}}{\partial \, P} - \frac{A_{j,k}}{\sum_k \, A_{j,k}} \sum_k \frac{\partial \, A_{j,k}}{\partial \, P} \right) \\
\frac{\partial \, A_{j,k}}{\partial \, P} &amp;= \frac{\partial \, A_{j,k}}{\partial \, \mu_j} \frac{\partial \mu_j}{\partial P} \\
\frac{\partial \, r_{j,k}}{\partial \, P} &amp;= \frac{R_j}{\sum_k \, A_{j,k}} \left( \frac{\partial \, A_{j,k}}{\partial \, \mu_j} \frac{\partial \mu_j}{\partial P} - \frac{A_{j,k}}{\sum_k \, A_{j,k}} \sum_k \frac{\partial \, A_{j,k}}{\partial \, \mu_j} \frac{\partial \mu_j}{\partial P} \right) \\
\end{aligned}\]</p><p>Since <span>$\frac{\partial \mu_j}{\partial P}$</span> has no dependence on the metallicity index <span>$k$</span>, we can pull it out of the sum in the final term and combine it into the prefactor as</p><p class="math-container">\[\frac{\partial \, r_{j,k}}{\partial \, P} = \frac{R_j}{\sum_k \, A_{j,k}} \frac{\partial \mu_j}{\partial P} \left( \frac{\partial \, A_{j,k}}{\partial \, \mu_j} - \frac{A_{j,k}}{\sum_k \, A_{j,k}} \sum_k \frac{\partial \, A_{j,k}}{\partial \, \mu_j} \right)\]</p><p>so that we can reuse the majority of the calculation for all the parameters <span>$P$</span> in the model for <span>$\mu_j$</span>, changing only a multiplicative prefactor of <span>$\frac{\partial \mu_j}{\partial P}$</span>. This means that the partial derivative of the objective with respect to <span>$P$</span> becomes</p><p class="math-container">\[\begin{aligned}
\frac{\partial \, F}{\partial \, P} &amp;= \sum_{j,k} \frac{\partial \, F}{\partial \, r_{j,k}} \, \frac{\partial \, r_{j,k}}{\partial \, P} \\
&amp;= \sum_j \frac{R_j}{\sum_k \, A_{j,k}} \frac{\partial \mu_j}{\partial P} \sum_k \frac{\partial \, F}{\partial \, r_{j,k}} \, \left( \frac{\partial \, A_{j,k}}{\partial \, \mu_j} - \frac{A_{j,k}}{\sum_k \, A_{j,k}} \sum_k \frac{\partial \, A_{j,k}}{\partial \, \mu_j} \right) \\
\end{aligned}\]</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../../fixed_amr/">« Fixed Age-Metallicity Relations</a><a class="docs-footer-nextpage" href="../../dispersion_models/">Metallicity Dispersion Models »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.11.4 on <span class="colophon-date" title="Friday 16 May 2025 16:26">Friday 16 May 2025</span>. Using Julia version 1.11.5.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
